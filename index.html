<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <title>Watch YouTube Together + Video Call</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
Â  <style>
Â  Â  :root{
Â  Â  Â  --bg:#0c0d0f; --panel:#14171b; --border:#232834;
Â  Â  Â  --text:#e8eef3; --muted:#97a3ae; --accent:#00e1ff;
Â  Â  Â  --safe-top: env(safe-area-inset-top, 0px);
Â  Â  Â  --safe-right: env(safe-area-inset-right, 0px);
Â  Â  Â  --safe-bottom: env(safe-area-inset-bottom, 0px);
Â  Â  Â  --safe-left: env(safe-area-inset-left, 0px);
Â  Â  }
Â  Â  *{box-sizing:border-box}
Â  Â  html,body{height:100%}
Â  Â  body{
Â  Â  Â  margin:0; background:var(--bg); color:var(--text);
Â  Â  Â  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
Â  Â  Â  line-height:1.4; overflow:hidden;
Â  Â  Â  padding:var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
Â  Â  Â  overscroll-behavior:contain;
Â  Â  }
Â  Â  .hidden{display:none !important}

Â  Â  .btn{
Â  Â  Â  display:inline-flex; align-items:center; justify-content:center;
Â  Â  Â  padding:10px 12px; border-radius:10px; border:1px solid var(--border);
Â  Â  Â  background:#0f1116; color:var(--text); font-weight:600; font-size:14px;
Â  Â  Â  cursor:pointer; line-height:1; white-space:nowrap;
Â  Â  }
Â  Â  .btn-primary{background:var(--accent); color:#001218; border-color:transparent}
Â  Â  .btn-sm{padding:10px 12px; min-width:96px}
Â  Â  input[type=text]{
Â  Â  Â  width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
Â  Â  Â  background:#0f1116; color:#e8eef3; font-size:14px; line-height:1;
Â  Â  }
Â  Â  input::placeholder{color:var(--muted)}
    input:disabled, .btn:disabled{
      opacity: 0.5;
      cursor: not-allowed;
    }

Â  Â  /* CONNECT SCREEN */
Â  Â  .connectScreen{
Â  Â  Â  height:100dvh; width:100vw; display:flex; align-items:center; justify-content:center; padding:16px;
Â  Â  }
Â  Â  .connect{
Â  Â  Â  width:min(480px, 92vw);
Â  Â  Â  background:var(--panel); border:1px solid var(--border); border-radius:14px;
Â  Â  Â  padding:16px; display:flex; flex-direction:column; gap:10px;
Â  Â  }
Â  Â  .title{font-weight:800; color:var(--accent); text-align:center}
Â  Â  .sub{color:var(--muted); font-size:13px; text-align:center}
Â  Â  .row{display:flex; gap:8px; align-items:center}
Â  Â  .row input{flex:1}

Â  Â  /* SESSION LAYOUT */
Â  Â  .session{
Â  Â  Â  height:100dvh; width:100vw; display:grid; gap:0;
Â  Â  Â  grid-template-columns: 1fr 1fr; grid-template-rows: 1fr;
Â  Â  Â  position:fixed; inset:0;
Â  Â  }
Â  Â  @media (max-width: 680px){
Â  Â  Â  .session{ grid-template-columns:1fr; grid-template-rows:1fr 1fr; }
Â  Â  }
Â  Â  .left,.right{min-width:0; min-height:0}

Â  Â  /* YOUTUBE PANE */
Â  Â  .left{position:relative; background:#000}
Â  Â  .ytWrap{position:absolute; inset:0; background:#000; overflow:hidden}
Â  Â  #ytPlayer{width:100%; height:100%; border:0;}

Â  Â  .badges{
Â  Â  Â  position:absolute; top:8px; left:8px; display:flex; gap:6px; z-index:2;
Â  Â  Â  user-select:none; pointer-events:none;
Â  Â  }
Â  Â  .badge{
Â  Â  Â  background:rgba(0,0,0,.45); color:#eaf2f7; border:1px solid rgba(255,255,255,.12);
Â  Â  Â  padding:4px 8px; border-radius:999px; font-size:12px; backdrop-filter:saturate(120%) blur(6px);
Â  Â  }
Â  Â  .urlBar{
Â  Â  Â  position:absolute; bottom:10px; left:10px; right:10px; z-index:3;
Â  Â  Â  display:flex; gap:8px; pointer-events:auto;
Â  Â  }
Â  Â  .urlBar input{flex:1}

Â  Â  /* CALL PANE */
Â  Â  .right{
Â  Â  Â  display:flex; flex-direction:column; background:var(--panel);
Â  Â  Â  border-left:1px solid var(--border);
Â  Â  }
Â  Â  @media (max-width: 680px){
Â  Â  Â  .right{border-left:none; border-top:1px solid var(--border);}
Â  Â  }
Â  Â  .callPane{
Â  Â  Â  flex:1; position:relative; padding:10px;
Â  Â  Â  display:flex; flex-direction:column; gap:10px;
Â  Â  }
Â  Â  .videoGrid{
Â  Â  Â  flex:1; display:flex; flex-direction:column; gap:10px;
Â  Â  }
Â  Â  .remoteVideoWrap, .localVideoWrap{
Â  Â  Â  position:relative; background:#000; border-radius:12px; overflow:hidden;
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  flex:1;
Â  Â  Â  display:flex; align-items:center; justify-content:center;
Â  Â  }
Â  Â  .localVideoWrap{
Â  Â  Â  max-height:40%;
Â  Â  }
Â  Â  video{
Â  Â  Â  width:100%; height:100%; object-fit:cover; background:#000;
Â  Â  }
Â  Â  .label{
Â  Â  Â  position:absolute; top:6px; left:8px; padding:2px 6px; border-radius:999px;
Â  Â  Â  background:rgba(0,0,0,.6); color:#f1f5f9; font-size:11px;
Â  Â  }
Â  Â  .controls{
Â  Â  Â  display:flex; gap:8px; justify-content:center; padding-top:4px;
Â  Â  }
Â  Â  .btn-danger{
Â  Â  Â  background:#ff4b6f; border-color:transparent; color:#fff;
Â  Â  }
Â  Â  .hint{
Â  Â  Â  text-align:center; font-size:12px; color:var(--muted);
Â  Â  }
Â  </style>

Â  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
Â  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>

<section id="connectScreen" class="connectScreen">
Â  <div class="connect">
Â  Â  <div class="title">ğŸ“º YouTube Watch + Call</div>
Â  Â  <div class="sub">Host loads a YouTube link, both see the video in sync and talk over video call.</div>

Â  Â  <button id="createBtn" class="btn btn-primary">Create Room (Host)</button>

Â  Â  <div class="row">
Â  Â  Â  <input id="roomId" type="text" placeholder="Room ID" autofocus />
Â  Â  Â  <button id="joinBtn" class="btn btn-primary btn-sm">Join</button>
Â  Â  </div>

Â  Â  <div id="connectLog" class="sub"></div>
Â  </div>
</section>

<section id="sessionScreen" class="session hidden">
Â  Â  <div class="left">
Â  Â  <div class="ytWrap">
Â  Â  Â  <div class="badges">
Â  Â  Â  Â  <span id="roleBadge" class="badge">Not connected</span>
Â  Â  Â  Â  <span id="statusBadge" class="badge">Idle</span>
Â  Â  Â  </div>

Â  Â  Â  <div id="ytPlayer"></div>

Â  Â  Â  <div class="urlBar" id="urlBar">
Â  Â  Â  Â  Â  Â  Â  Â  <input id="ytInput" type="text" placeholder="Player loading..." disabled />
Â  Â  Â  Â  <button id="loadBtn" class="btn btn-primary btn-sm" disabled>Load</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div class="right">
Â  Â  <div class="callPane">
Â  Â  Â  <div class="videoGrid">
Â  Â  Â  Â  <div class="remoteVideoWrap">
Â  Â  Â  Â  Â  <span class="label">Peer</span>
Â  Â  Â  Â  Â  <video id="remoteVideo" playsinline autoplay></video>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="localVideoWrap">
Â  Â  Â  Â  Â  <span class="label">You</span>
Â  Â  Â  Â  Â  <video id="localVideo" muted playsinline autoplay></video>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="controls">
Â  Â  Â  Â  <button id="startCallBtn" class="btn btn-primary btn-sm">Start Call</button>
Â  Â  Â  Â  <button id="toggleMuteBtn" class="btn btn-sm">Mute</button>
Â  Â  Â  Â  <button id="toggleCamBtn" class="btn btn-sm">Camera Off</button>
Â  Â  Â  Â  <button id="endCallBtn" class="btn btn-danger btn-sm">End</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="hint">
Â  Â  Â  Â  Join â†’ hit â€œStart Callâ€ â†’ host pastes YouTube link â†’ both watch & talk.
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</section>

<script>
Â  // === Shortcuts & elements ===
Â  const $ = id => document.getElementById(id);
Â  const connectScreen = $('connectScreen');
Â  const sessionScreen = $('sessionScreen');
Â  const roleBadge = $('roleBadge');
Â  const statusBadge = $('statusBadge');
Â  const connectLog = $('connectLog');
Â  const urlBar = $('urlBar');
Â  const ytInput = $('ytInput');
Â  const loadBtn = $('loadBtn');

Â  const localVideo = $('localVideo');
Â  const remoteVideo = $('remoteVideo');
Â  const startCallBtn = $('startCallBtn');
Â  const toggleMuteBtn = $('toggleMuteBtn');
Â  const toggleCamBtn = $('toggleCamBtn');
Â  const endCallBtn = $('endCallBtn');

Â  let peer, conn;
Â  let isHost = false;
Â  let roomIdInput = $('roomId');

Â  // WebRTC / PeerJS media
Â  let localStream = null;
Â  let currentCall = null;

Â  // YouTube
Â  let player = null;
Â  let ytReady = false;
Â  let currentVideoId = null;
Â  let isSeeking = false;

Â  // === UI helpers ===
Â  function showConnect(msg){ connectLog.textContent = msg || ''; }
Â  function setStatus(text){ statusBadge.textContent = text; }

Â  function toSession(role){
Â  Â  connectScreen.classList.add('hidden');
Â  Â  sessionScreen.classList.remove('hidden');
Â  Â  roleBadge.textContent = role === 'host' ? 'Host' : 'Guest';
Â  Â  urlBar.style.display = role === 'host' ? 'flex' : 'none';
Â  }

Â  // === YouTube IFrame API ===
Â  window.onYouTubeIframeAPIReady = function(){
Â  Â  player = new YT.Player('ytPlayer', {
Â  Â  Â  height: '100%',
Â  Â  Â  width: '100%',
Â  Â  Â  videoId: '',
Â  Â  Â  playerVars:{
Â  Â  Â  Â  controls:1,
Â  Â  Â  Â  rel:0,
Â  Â  Â  Â  modestbranding:1
Â  Â  Â  },
Â  Â  Â  events:{
Â  Â  Â  Â  'onReady': onPlayerReady,
Â  Â  Â  Â  'onStateChange': onPlayerStateChange
Â  Â  Â  }
Â  Â  });
Â  };

Â  // FIX 2: Enable controls when player is ready
Â  function onPlayerReady(){
Â  Â  ytReady = true;
Â  Â  setStatus('Idle');
Â  Â  ytInput.disabled = false;
Â  Â  loadBtn.disabled = false;
Â  Â  ytInput.placeholder = 'Paste YouTube URL or ID (Host only)';
Â  }

Â  // FIX 3: Autoplay on load (for host) and send sync
Â  function onPlayerStateChange(e){
Â  Â  if (!ytReady || !currentVideoId) return; // Don't run if player isn't ready

Â  Â  const state = e.data;
Â  Â  const t = player.getCurrentTime();

Â  Â  // --- This is the host's logic ---
Â  Â  if (isHost){
Â  Â  Â  // NEW: If the video has just been loaded (is 'cued'), play it!
Â  Â  Â  if (state === YT.PlayerState.CUED){
Â  Â  Â  Â  player.playVideo();
Â  Â  Â  Â  return; // We'll send the 'play' sync on the *next* state change
Â  Â  Â  }

Â  Â  Â  // Only send sync messages if a guest is actually connected
Â  Â  Â  if (conn){
imgÂ  Â  Â  Â  if (state === YT.PlayerState.PLAYING){
Â  Â  Â  Â  Â  conn.send({type:'sync', action:'play', time:t, vid:currentVideoId});
Â  Â  Â  Â  } else if (state === YT.PlayerState.PAUSED){
Â  Â  Â  Â  Â  conn.send({type:'sync', action:'pause', time:t, vid:currentVideoId});
Â  Â  Â  Â  }
Â  Â  Â  }
Â  _ Â  }
Â  }

Â  function parseYouTubeId(urlOrId){
Â  Â  // Accept raw ID or full URL
Â  Â  if (!urlOrId) return null;
Â  Â  const idRegex = /(?:v=|youtu\.be\/|embed\/|shorts\/)([A-Za-z0-9_-]{6,})/;
Â  Â  const m = urlOrId.match(idRegex);
Â  Â  if (m && m[1]) return m[1];
Â  Â  // if looks like bare id
Â  Â  if (/^[A-Za-z0-9_-]{6,}$/.test(urlOrId)) return urlOrId;
Â  Â  return null;
Â  }

Â  function hostLoadVideo(){
Â  Â  if (!isHost || !ytReady) return;
Â  Â  const raw = ytInput.value.trim();
Â  Â  const vid = parseYouTubeId(raw);
Â  Â  if (!vid){
Â  Â  Â  alert('Invalid YouTube URL or ID');
Â  Â  Â  return;
Â  Â  }
Â  Â  currentVideoId = vid;
Â  Â  setStatus('Loadingâ€¦');
Â  Â  player.loadVideoById(vid);
Â  Â  conn && conn.send({type:'cmd', cmd:'load', vid});
Â  }

Â  function guestLoadVideo(vid){
Â  Â  if (!ytReady || !vid) return;
Â  Â  currentVideoId = vid;
Â  Â  setStatus('Loadingâ€¦');
Â  Â  player.loadVideoById(vid);
Â  }

Â  function applySync(msg){
Â  Â  if (!ytReady || !currentVideoId) return;

Â  Â  // If host changed video, sync to same one
Â  Â  if (msg.vid && msg.vid !== currentVideoId){
Â  Â  Â  currentVideoId = msg.vid;
Â  Â  Â  player.loadVideoById(currentVideoId);
Â  Â  }

Â  Â  const target = msg.time || 0;
Â  Â  const diff = Math.abs(player.getCurrentTime() - target);
Â  Â  if (diff > 0.5){
Â  Â  Â  isSeeking = true;
Â  Â  Â  player.seekTo(target, true);
Â  Â  Â  setTimeout(()=>{ isSeeking = false; }, 300);
Â  Â  }

Â  Â  if (msg.action === 'play'){
Â  Â  Â  player.playVideo();
Â  Â  } else if (msg.action === 'pause'){
Â  Â  MÂ  player.pauseVideo();
Â  Â  }
Â  }

Â  // === PeerJS connect flow ===
Â  $('createBtn').onclick = () => {
Â  Â  isHost = true;
Â  Â  peer = new Peer();
Â  Â  peer.on('open', id => {
Â  Â  Â  showConnect('Room ID: ' + id);
Â  Â  });
Â  Â  peer.on('connection', c => {
Â  Â  Â  conn = c;
Â  Â  Â  wireConnection();
Â  Â  Â  toSession('host');
Â  Â  });
Â  };

Â  $('joinBtn').onclick = tryJoin;
Â  roomIdInput.addEventListener('keydown', e => {
Â  Â  if (e.key === 'Enter') tryJoin();
Â  });

Â  function tryJoin(){
Â  Â  const id = roomIdInput.value.trim();
Â  Â  if (!id){
Â  Â  Â  showConnect('Enter a room ID.');
Â  Â  Â  roomIdInput.focus();
Â  Â  Â  return;
Â  Â  }
Â  Â  isHost = false;
Â  Â  peer = new Peer();
Â  Â  peer.on('open', () => {
Â  Â  Â  conn = peer.connect(id);
Â  Â  Â  conn.on('open', () => {
Â  Â  Â  Â  wireConnection();
Â  Â  Â  Â  toSession('guest');
Â  Â  Â  });
Â  Â  });
Â  }

Â  function wireConnection(){
Â  Â  conn.on('data', data => {
Â  Â  Â  if (data.type === 'cmd' && data.cmd === 'load'){
Â  Â  Â  Â  guestLoadVideo(data.vid);
Â  Â  Â  } else if (data.type === 'sync'){
Â  Â  Â  Â  applySync(data);
Â  Â  Â  }
Â  Â  });
Â  Â  conn.on('close', () => {
Â  Â  Â  location.reload();
Â  Â  });
Â  }

Â  // === Media (WebRTC) ===
Â  async function ensureLocalStream(){
Â  Â  if (localStream) return localStream;
Â  Â  try{
Â  Â  Â  localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
Â  Â  Â  localVideo.srcObject = localStream;
Â  Â  Â  return localStream;
Â  Â  }catch(err){
Â  Â  Â  console.error('getUserMedia error', err);
Â  Â  Â  alert('Could not access camera/microphone.');
Â  Â  Â  throw err;
EÂ  Â  }
Â  }

Â  function cleanupCall(){
Â  Â  if (currentCall){
Â  Â  Â  currentCall.close();
Â  Â  Â  currentCall = null;
Â  Â  }
Â  Â  if (remoteVideo.srcObject){
Â  Â  Â  remoteVideo.srcObject.getTracks().forEach(t=>t.stop());
Â  Â  Â  remoteVideo.srcObject = null;
Â  Â  }
Â  }

Â  // Host answers calls
Â  function setupCallHandlers(){
Â  Â  peer.on('call', async call => {
Â  Â  Â  try{
Â  Â  Â  Â  const stream = await ensureLocalStream();
Â  Â  Â  Â  call.answer(stream);
Â  Â  Â  Â  currentCall = call;
Â  Â  Â  Â  call.on('stream', remoteStream => {
Additional: Â  Â  Â  Â  Â  remoteVideo.srcObject = remoteStream;
Â  Â  Â  Â  });
Â  Â  Â  Â  call.on('close', ()=>{ cleanupCall(); });
Â  Â  Â  }catch(e){
Â  Â  Â  Â  console.error(e);
Â  Â  Â  }
Â  Â  });
Â  }

Â  // Guest starts call to host
Â  async function startCall(){
Â  Â  if (!peer || !conn) return;
Â  Â  const targetId = conn.peer; // host's PeerJS id
Â  Â  try{
Â  Â  Â  const stream = await ensureLocalStream();
Â  Â  Â  const call = peer.call(targetId, stream);
Â  Â  Â  currentCall = call;
Â  Â  Â  call.on('stream', remoteStream => {
Â  Â  Â  Â  remoteVideo.srcObject = remoteStream;
Â  Â  Â  });
Â  Â  Â  call.on('close', ()=>{ cleanupCall(); });
Â  Â  }catch(e){
Â  Â  Â  console.error(e);
Â  Â  }
Â  }

Â  // === Buttons ===
Â  loadBtn.onclick = hostLoadVideo;

Â  startCallBtn.onclick = async () => {
Â  Â  if (!peer) return;
Â  Â  setupCallHandlers();
Â  Â  // Guest initiates call (host will only answer)
Â  Â  if (!isHost){
Â  Â  Â  await startCall();
Â  Â  }else{
Â  Â  Â  // host wants to see self even before call
Â  Â  Â  await ensureLocalStream();
Â  Â  }
Â  };

Â  toggleMuteBtn.onclick = () => {
Â  Â  if (!localStream) return;
Â  Â  const audioTracks = localStream.getAudioTracks();
Â  Â  if (!audioTracks.length) return;
Â  Â  const enabled = audioTracks[0].enabled;
Â  Â  audioTracks.forEach(t => t.enabled = !enabled);
CSS Â  toggleMuteBtn.textContent = enabled ? 'Unmute' : 'Mute';
Â  };

Â  toggleCamBtn.onclick = () => {
Â  Â  if (!localStream) return;
Â  Â  const videoTracks = localStream.getVideoTracks();
Â  Â  if (!videoTracks.length) return;
Â  Â  const enabled = videoTracks[0].enabled;
Â  Â  videoTracks.forEach(t => t.enabled = !enabled);
Next Â  toggleCamBtn.textContent = enabled ? 'Camera On' : 'Camera Off';
Â  };

Â  endCallBtn.onclick = () => {
Â  	  cleanupCall();
Â  };

Â  // Init: when peer is created, also prep call handlers
Â  const origPeer = Peer;
Â  Peer = function(...args){
Â  Â  const p = new origPeer(...args);
Â  Â  p.on('open', ()=>{ setupCallHandlers(); });
Â  	  return p;
Â  };
</script>
</body>
</html>
