<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <title>Watch YouTube Together + Video Call + Chat</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
Â  <style>
Â  Â  :root{
Â  Â  Â  --bg:#0c0d0f; --panel:#14171b; --border:#232834;
Â  Â  Â  --text:#e8eef3; --muted:#97a3ae; --accent:#00e1ff;
Â  Â  Â  --safe-top: env(safe-area-inset-top, 0px);
Â  Â  Â  --safe-right: env(safe-area-inset-right, 0px);
Â  Â  Â  --safe-bottom: env(safe-area-inset-bottom, 0px);
Â  Â  Â  --safe-left: env(safe-area-inset-left, 0px);
Â  Â  Â Â 
Â  Â  Â  /* --- ADDED FOR CHAT KEYBOARD --- */
Â  Â  Â  --kbd: 0px;
Â  Â  Â  --composer-h: 56px;
Â  Â  }
Â  Â  *{box-sizing:border-box}
Â  Â  html,body{height:100%}
Â  Â  body{
Â  Â  Â  margin:0; background:var(--bg); color:var(--text);
Â  Â  Â  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
Â  Â  Â  line-height:1.4; overflow:hidden;
Â  Â  Â  padding:var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
Â  Â  Â  overscroll-behavior:contain;
Â  Â  }
Â  Â  .hidden{display:none !important}

Â  Â  .btn{
Â  Â  Â  display:inline-flex; align-items:center; justify-content:center;
Â  Â  Â  padding:10px 12px; border-radius:10px; border:1px solid var(--border);
Â  Â  Â  background:#0f1116; color:var(--text); font-weight:600; font-size:14px;
Â  Â  Â  cursor:pointer; line-height:1; white-space:nowrap;
Â  Â  }
Â  Â  .btn:disabled{
Â  Â  Â  background:var(--border); color:var(--muted); cursor:not-allowed;
Â  Â  }
Â  Â  .btn-primary:disabled{
Â  Â  Â  background:#004a5c; color:var(--muted); border-color:transparent;
Â  Â  }
Â  Â  input[type=text]:disabled{
Â  Â  Â  background:var(--border); cursor:not-allowed;
Â  Â  }

Â  Â  .btn-primary{background:var(--accent); color:#001218; border-color:transparent}
Â  Â  .btn-sm{padding:10px 12px; min-width:96px}
Â  Â  input[type=text]{
Â  Â  Â  width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
Â  Â  Â  background:#0f1116; color:#e8eef3; font-size:14px; line-height:1;
Â  Â  }
Â  Â  input::placeholder{color:var(--muted)}

Â  Â  /* CONNECT SCREEN */
Â  Â  .connectScreen{
Â  Â  Â  height:100dvh; width:100vw; display:flex; align-items:center; justify-content:center; padding:16px;
Â  Â  }
Â  Â  .connect{
Â  Â  Â  width:min(480px, 92vw);
Â  Â  Â  background:var(--panel); border:1px solid var(--border); border-radius:14px;
Â  Â  Â  padding:16px; display:flex; flex-direction:column; gap:10px;
Â  Â  }
Â  Â  .title{font-weight:800; color:var(--accent); text-align:center}
Â  Â  .sub{color:var(--muted); font-size:13px; text-align:center}
Â  Â  .row{display:flex; gap:8px; align-items:center}
Â  Â  .row input{flex:1}

Â  Â  /* SESSION LAYOUT */
Â  Â  .session{
Â  Â  Â  height:100dvh; width:100vw; display:grid; gap:0;
Â  Â  Â  grid-template-columns: 1fr 1fr; grid-template-rows: 1fr;
Â  Â  Â  position:fixed; inset:0;
Â  Â  }
Â  Â  @media (max-width: 680px){
Â  Â  Â  .session{ grid-template-columns:1fr; grid-template-rows:1fr 1fr; }
Â  Â  }
Â  Â  .left,.right{min-width:0; min-height:0}

Â  Â  /* YOUTUBE PANE */
Â  Â  .left{position:relative; background:#000}
Â  Â  .ytWrap{position:absolute; inset:0; background:#000; overflow:hidden}
Â  Â  #ytPlayer{width:100%; height:100%; border:0;}

Â  Â  .badges{
Â  Â  Â  position:absolute; top:8px; left:8px; display:flex; gap:6px; z-index:2;
Â  Â  Â  user-select:none; pointer-events:none;
Â  Â  }
Â  Â  .badge{
Â  Â  Â  background:rgba(0,0,0,.45); color:#eaf2f7; border:1px solid rgba(255,255,255,.12);
Â  Â  Â  padding:4px 8px; border-radius:999px; font-size:12px; backdrop-filter:saturate(120%) blur(6px);
Â  Â  }
Â  Â  .urlBar{
Â  Â  Â  position:absolute; bottom:10px; left:10px; right:10px; z-index:3;
Â  Â  Â  display:flex; gap:8px; pointer-events:auto;
Â  Â  }
Â  Â  .urlBar input{flex:1}

Â  Â  /* RIGHT PANE (CALL + CHAT) */
Â  Â  .right{
Â  Â  Â  display:flex; flex-direction:column; background:var(--panel);
Â  Â  Â  border-left:1px solid var(--border);
Â  Â  }
Â  Â  @media (max-width: 680px){
Â  Â  Â  .right{border-left:none; border-top:1px solid var(--border);}
Â  Â  }
Â  Â Â 
Â  Â  /* --- CALL PANE --- */
Â  Â  .callPane{
Â  Â  Â  flex:1; position:relative; padding:10px;
Â  Â  Â  display:flex; flex-direction:column; gap:10px;
Â  Â  }
Â  Â Â 
Â  Â  .videoGrid{
Â  Â  Â  flex:1;
Â  Â  Â  position:relative;Â 
Â  Â  }
Â  Â  .remoteVideoWrap {
Â  Â  Â  position: absolute; inset: 0;
Â  Â  Â  background: #000; border-radius: 12px; overflow: hidden;
Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  }
Â  Â  .localVideoWrap {
Â  Â  Â  position: absolute; z-index: 10;
Â  Â  Â  bottom: 10px; right: 10px;
Â  Â  Â  width: 30%; max-width: 160px; min-width: 100px;
Â  Â  Â  aspect-ratio: 4/3;
Â  Â  Â  background: #000; border-radius: 12px; overflow: hidden;
Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  }
Â  Â Â 
Â  Â  video{
Â  Â  Â  width:100%; height:100%; object-fit:cover; background:#000;
Â  Â  }
Â  Â  .label{
Â  Â  Â  position:absolute; top:6px; left:8px; padding:2px 6px; border-radius:999px;
Â  Â  Â  background:rgba(0,0,0,.6); color:#f1f5f9; font-size:11px;
Â  Â  }
Â  Â  .controls{
Â  Â  Â  display:flex; gap:8px; justify-content:center; padding-top:4px; flex-wrap:wrap;
Â  Â  }
Â  Â  .btn-danger{
Â  Â  Â  background:#ff4b6f; border-color:transparent; color:#fff;
Â  Â  }
Â  Â  .hint{
Â  Â  Â  text-align:center; font-size:12px; color:var(--muted);
Â  Â  }
Â  Â Â 
Â  Â  /* --- CHAT PANE (FROM FILE 1) --- */
Â  Â  .chatPane{
Â  Â  Â  flex:1; display:flex; flex-direction:column;Â 
Â  Â  Â  min-height:0; position:relative;
Â  Â  }
Â  Â  #messages{
Â  Â  Â  flex:1; min-height:0; overflow-y:auto; overflow-x:hidden; padding:12px; background:#0f1116;
Â  Â  Â  display:flex; flex-direction:column; gap:8px;
Â  Â  Â  word-break:break-word; overflow-wrap:anywhere; white-space:pre-wrap;
Â  Â  Â Â 
Â  Â  Â  position:absolute; top:0; left:0; right:0;
Â  Â  Â  bottom: calc(var(--composer-h) + var(--kbd));
Â  Â  }
Â  Â  .line{display:flex; width:100%}
Â  Â  .from-me{justify-content:flex-end}
Â  Â  .from-peer{justify-content:flex-start}
Â  Â Â 
Â  Â  .bubble{
Â  Â  Â  max-width:88%;
Â  Â  Â  padding:10px 12px;
Â  Â  Â  border-radius:14px;
Â  Â  Â  border:1px solid transparent;
Â  Â  Â  box-shadow:0 1px 2px rgba(0,0,0,.25);
Â  Â  Â  font-size:14px;
Â  Â  }
Â  Â  .bubble.me{
Â  Â  Â  background:rgba(0,212,179,.15); border-color:rgba(0,212,179,.35); color:#d9fff7;
Â  Â  Â  border-top-right-radius:6px;
Â  Â  }
Â  Â  .bubble.peer{
Â  Â  Â  background:rgba(255,114,210,.14); border-color:rgba(255,114,210,.35); color:#ffe6f6;
Â  Â  Â  border-top-left-radius:6px;
Â  Â  }
Â  Â  .line.from-sys {Â 
Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  width: 100%;
Â  Â  }
Â  Â  .bubble.sys {
Â  Â  Â  Â  width: 100%; max-width: 100%; text-align: center;
Â  Â  Â  Â  background: rgba(151,163,174,.15); color: var(--muted);
Â  Â  Â  Â  border: none; box-shadow: none; font-size: 12px; font-style: italic;
Â  Â  }

Â  Â  .composer{
Â  Â  Â  display:flex; gap:8px; padding:8px; border-top:1px solid var(--border); background:var(--panel);
Â  Â  Â  position:absolute; left:0; right:0; bottom: var(--kbd);
Â  Â  }
Â  Â  .composer input{flex:1}
Â  Â  .composer button{
Â  Â  Â  Â  padding:10px 12px; border-radius:10px; border:1px solid transparent;
Â  Â  Â  Â  background:var(--accent); color:#001218; font-weight:700;
Â  Â  }
Â  Â  .kbd-open #messages{ scroll-behavior:auto; }

Â  </style>

Â  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>

<section id="connectScreen" class="connectScreen">
Â  <div class="connect">
Â  Â  <div class="title">ğŸ“º YouTube Watch + Call + Chat</div>
Â  Â  <div class="sub">Host loads a YouTube link, both see the video in sync and talk over video call or text chat.</div>

Â  Â  <button id="createBtn" class="btn btn-primary">Create Room (Host)</button>

Â  Â  <div class="row">
Â  Â  Â  <input id="guestNameInput" type="text" placeholder="Your Name" />
Â  Â  Â  <input id="roomId" type="text" placeholder="Room ID" autofocus />
Â  Â  Â  <button id="joinBtn" class="btn btn-primary btn-sm">Join</button>
Â  Â  </div>

Â  Â  <div id="connectLog" class="sub"></div>
Â  </div>
</section>

<section id="sessionScreen" class="session hidden">
Â  <div class="left">
Â  Â  <div class="ytWrap">
Â  Â  Â  <div class="badges">
Â  Â  Â  Â  <span id="roleBadge" class="badge">Not connected</span>
Â  Â  Â  Â  <span id="statusBadge" class="badge">Idle</span>
Â  Â  Â  </div>

Â  Â  Â  <div id="ytPlayer"></div>

Â  Â  Â  <div class="urlBar" id="urlBar">
Â  Â  Â  Â  <input id="ytInput" type="text" placeholder="Loading player..." disabled />
Â  Â  Â  Â  <button id="loadBtn" class="btn btn-primary btn-sm" disabled>Load</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="right">
Â  Â  <div class="callPane" id="callPane">
Â  Â  Â  <div class="videoGrid">
Â  Â  Â  Â  <div class="remoteVideoWrap">
Â  Â  Â  Â  Â  <span class="label">Peer</span>
Â  Â  Â  Â  Â  <video id="remoteVideo" playsinline autoplay></video>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="localVideoWrap">
Â  Â  Â  Â  Â  <span class="label">You</span>
Â  Â  Â  Â  Â  <video id="localVideo" muted playsinline autoplay></video>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="controls">
Â  Â  Â  Â  <button id="startCallBtn" class="btn btn-primary btn-sm">Start Call</button>
Â  Â  Â  Â  <button id="toggleMuteBtn" class="btn btn-sm">Mute</button>
Â  Â  Â  Â  <button id="toggleCamBtn" class="btn btn-sm">Camera Off</button>
Â  Â  Â  Â  <button id="endCallBtn" class="btn btn-danger btn-sm">End</button>
Â  Â  Â  Â  <button id="showChatBtn" class="btn btn-sm">Show Chat</button>
Â  Â  Â  Â  <button id="showCallBtn" class="btn btn-sm hidden">Show Call</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="hint">
Â  Â  Â  Â  Join â†’ hit â€œStart Callâ€ â†’ host pastes YouTube link â†’ both watch & talk.
Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="chatPane hidden" id="chatPane">
Â  Â  Â  Â  <div id="messages"></div>
Â  Â  Â  Â  <div class="composer">
Â  Â  Â  Â  Â  Â  <input id="msgInput" type="text" placeholder="Messageâ€¦" />
Â  Â  Â  Â  Â  Â  <button id="sendBtn" class="btn btn-primary btn-sm">Send</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  </div>
</section>

<script>
Â  // === Shortcuts & elements ===
Â  const $ = id => document.getElementById(id);
Â  const connectScreen = $('connectScreen');
Â  const sessionScreen = $('sessionScreen');
Â  const roleBadge = $('roleBadge');
Â  const statusBadge = $('statusBadge');
Â  const connectLog = $('connectLog');
Â  const urlBar = $('urlBar');
Â  const ytInput = $('ytInput');
Â  const loadBtn = $('loadBtn');

Â  const localVideo = $('localVideo');
Â  const remoteVideo = $('remoteVideo');
Â  const startCallBtn = $('startCallBtn');
Â  const toggleMuteBtn = $('toggleMuteBtn');
Â  const toggleCamBtn = $('toggleCamBtn');
Â  const endCallBtn = $('endCallBtn');
Â Â 
Â  // --- ADDED FROM CHAT APP ---
Â  const callPane = $('callPane');
Â  const chatPane = $('chatPane');
Â  const showChatBtn = $('showChatBtn');
Â  const showCallBtn = $('showCallBtn');
Â  const messages = $('messages');
Â  const msgInput = $('msgInput');
Â  const sendBtn = $('sendBtn');
Â  const guestNameInput = $('guestNameInput');
Â  // --- END ADDED ---

Â  let peer, conn;
Â  let isHost = false;
Â  let roomIdInput = $('roomId');
Â Â 
Â  // --- ADDED NAME GLOBALS ---
Â  let myName = 'Host';
Â  let peerName = 'Guest';

Â  // WebRTC / PeerJS media
Â  let localStream = null;
Â  let currentCall = null;

Â  // YouTube
Â  let player = null;
Â  let ytReady = false;
Â  let ytApiReady = false;Â 
Â  let currentVideoId = null;
Â  let isSeeking = false;

Â  // === UI helpers ===
Â  function showConnect(msg){ connectLog.textContent = msg || ''; }
Â  function setStatus(text){ statusBadge.textContent = text; }
Â  function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':m==='"'?'&quot;':'&#39;' }[m])) }

Â  function toSession(role){
Â  Â  connectScreen.classList.add('hidden');
Â  Â  sessionScreen.classList.remove('hidden');
Â  Â  roleBadge.textContent = role === 'host' ? 'Host' : 'Guest';
Â  Â  urlBar.style.display = role === 'host' ? 'flex' : 'none';
Â  Â Â 
Â  Â  if (ytApiReady) {
Â  Â  Â  createPlayer(role);
Â  Â  } else {
Â  Â  Â  window.onYouTubeIframeAPIReady = () => createPlayer(role);
Â  Â  }
Â  }
Â Â 
Â  // --- ADDED CHAT BUBBLE FUNCTIONS ---
Â  function addBubble(text, who){
Â  Â  Â  const line = document.createElement('div');
Â  Â  Â Â 
Â  Â  Â  let lineClass, bubbleClass;
Â  Â  Â  if (who === 'me') {
Â  Â  Â  Â  Â  lineClass = 'from-me'; bubbleClass = 'me';
Â  Â  Â  } else if (who === 'peer') {
Â  Â  Â  Â  Â  lineClass = 'from-peer'; bubbleClass = 'peer';
Â  Â  Â  } else { // 'sys'
Â  Â  Â  Â  Â  lineClass = 'from-sys'; bubbleClass = 'sys';
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  line.className = 'line ' + lineClass;
Â  Â  Â  const b = document.createElement('div');
Â  Â  Â  b.className = 'bubble ' + bubbleClass;
Â  Â  Â  b.innerHTML = text;
Â  Â  Â  line.appendChild(b);
Â  Â  Â  messages.appendChild(line);
Â  Â  Â  messages.scrollTop = messages.scrollHeight;
Â  }
Â Â 
Â  function log(html, cls){
Â  Â  Â  if (cls === 'sys') {
Â  Â  Â  Â  Â  addBubble(html, 'sys');
Â  Â  Â  } else {
Â  Â  Â  Â  Â  addBubble(html, cls==='me' ? 'me' : 'peer');
Â  Â  Â  }
Â  }
Â  // --- END CHAT FUNCTIONS ---

Â  // === YouTube IFrame API ===
Â  window.onYouTubeIframeAPIReady = function(){
Â  Â  ytApiReady = true;
Â  };
Â Â 
Â  function createPlayer(role) {
Â  Â  const playerControls = (role === 'host') ? 1 : 0;
Â  Â Â 
Â  Â  player = new YT.Player('ytPlayer', {
Â  Â  Â  height: '100%',
Â  Â  Â  width: '100%',
Â  Â  Â  videoId: '',
Â  Â  Â  playerVars:{
Â  Â  Â  Â  controls: playerControls,Â 
Â  Â  Â  Â  rel:0,
Â  Â  Â  Â  modestbranding:1,
Â  Â  Â  Â  iv_load_policy:3Â 
Â  Â  Â  },
Â  Â  Â  events:{
Â  Â  Â  Â  'onReady': onPlayerReady,
Â  Â  Â  Â  'onStateChange': onPlayerStateChange
Â  Â  Â  }
Â  Â  });
Â  }

Â  function onPlayerReady(){
Â  Â  ytReady = true;
Â  Â  setStatus('Idle');
Â  Â Â 
Â  Â  if (isHost) {
Â  Â  Â  ytInput.disabled = false;
Â  Â  Â  loadBtn.disabled = false;
Â  Â  Â  ytInput.placeholder = 'Paste YouTube URL or ID (Host only)';
Â  Â  } else {
Â  Â  Â  ytInput.placeholder = 'Waiting for host...';
Â  Â  }
Â  }

Â  function onPlayerStateChange(e){
Â  Â  if (!conn || !ytReady || !currentVideoId) return;
Â  Â  if (!isHost) return;Â 

Â  Â  const state = e.data;
Â  Â  const t = player.getCurrentTime();

Â  Â  if (state === YT.PlayerState.PLAYING){
Â  Â  Â  conn.send({type:'sync', action:'play', time:t, vid:currentVideoId});
s Â  } else if (state === YT.PlayerState.PAUSED){
Â  Â  Â  conn.send({type:'sync', action:'pause', time:t, vid:currentVideoId});
Â  Â  } else if (state === YT.PlayerState.BUFFERING){
Â  Â  Â  conn.send({type:'sync', action:'pause', time:t, vid:currentVideoId});
Â  Â  }
Â  }

Â  function parseYouTubeId(urlOrId){
Â  Â  if (!urlOrId) return null;
Â  Â  const idRegex = /(?:v=|youtu\.be\/|embed\/|shorts\/)([A-Za-z0-9_-]{6,})/;
Â  Â  const m = urlOrId.match(idRegex);
Â  Â  if (m && m[1]) return m[1];
Â  Â  if (/^[A-Za-z0-9_-]{6,}$/.test(urlOrId)) return urlOrId;
Â  Â  return null;
Â  }

Â  function hostLoadVideo(){
Â  Â  if (!isHost || !ytReady) return;Â 
Â  Â Â 
Â  Â  const raw = ytInput.value.trim();
Â  Â  const vid = parseYouTubeId(raw);
Â  Â  if (!vid){
Â  Â  Â  alert('Invalid YouTube URL or ID');
Â  Â  Â  return;
Â  Â  }
Â  Â  currentVideoId = vid;
Â  Â  setStatus('Loadingâ€¦');
Â  Â Â 
Â  Â  player.loadVideoById({'videoId': vid, 'startSeconds': 0});
Â  Â  conn && conn.send({type:'cmd', cmd:'load', vid});Â 

Â  Â  ytInput.value = '';
Â  }

Â  function guestLoadVideo(vid){
Â  Â  if (!ytReady || !vid) return;
Â  Â  currentVideoId = vid;
Â  Â  setStatus('Loadingâ€¦');
Â  Â  player.loadVideoById(vid);Â 
Â  }

Â  function applySync(msg){
Â  Â  if (!ytReady || isHost) return;

Â  Â  const targetTime = msg.time || 0;

Â  Â  if (msg.vid && msg.vid !== currentVideoId){
Â  Â  Â  currentVideoId = msg.vid;
Â  Â  Â  setStatus('Syncing to host...');
Â  Â  Â Â 
Â  Â  Â  player.loadVideoById({
Â  Â  Â  Â  'videoId': currentVideoId,
Â  Â  Â  Â  'startSeconds': targetTime
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  if (msg.action === 'play'){
Â  Â  Â  Â  Â  player.playVideo();
Â  Â  Â  Â  } else if (msg.action === 'pause'){
Â  Â  Â  Â  Â  player.pauseVideo();
Â  Â  Â  Â  }
Â  Â  Â  }, 500);Â 
Â  Â  Â Â 
Â  Â  Â  return;sÂ 
Â  Â  }

Â  Â  const diff = Math.abs(player.getCurrentTime() - targetTime);
Â  Â Â 
Â  Â  if (diff > 1 && !isSeeking){Â 
Â  Â  Â  isSeeking = true;
Â  Â  Â  player.seekTo(targetTime, true);
Â  Â  Â  setTimeout(()=>{ isSeeking = false; }, 500);Â 
Â  Â  }

Â  Â  if (msg.action === 'play'){
Â  Â  Â  player.playVideo();
Â  _ } else if (msg.action === 'pause'){
Â  Â  Â  player.pauseVideo();
Â  Â  }
Â  }

Â  // === PeerJS connect flow (MERGED) ===
Â  $('createBtn').onclick = () => {
Â  Â  isHost = true;
Â  Â  myName = 'Host';
Â  Â  // --- FIXED: Use a specific server and pass 'undefined' for ID ---
Â  Â  peer = new Peer(undefined, { host: '0.peerjs.com', port: 443, path: '/' });

Â  Â  peer.on('open', id => {
Â  Â  Â  showConnect('Room ID: ' + id);Â 
Â  Â  });
Â  Â  
Â  Â  // --- FIXED: Added error handler for host ---
Â  Â  peer.on('error', err => {
Â  Â  Â  Â  console.error('PeerJS Error:', err);
Â  Â  Â  Â  showConnect(`Error: Could not connect to PeerJS server. Try again. [${err.type}]`);
Â  Â  });
Â  Â  
Â  Â  peer.on('connection', c => {
Â  Â  Â  // --- ROOM LOCK LOGIC ---
Â  Â  Â  if (conn && conn.open) {
Â  Â  Â  Â  Â  console.warn(`WARN: Rejecting new connection from ${c.peer}, room is full.`);
Â  Â  Â  Â  Â  c.on('open', () => {
Â  Â  Â  Â  Â  Â  Â  c.send({ type: 'system', action: 'kick', reason: 'Room is full.' });
Â  Â  Â  Â  Â  Â  Â  setTimeout(() => c.close(), 500);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  }
Â  Â  Â  // --- END LOCK LOGIC ---
Â  Â  Â Â 
Â  Â  Â  conn = c;
Â  Â  Â  wireConnection();
Â  Â  Â  toSession('host');Â 
Â  Â  Â Â 
Â  Â  Â  // Send initial sync if video is already playing
Â  Â  Â  if (ytReady && currentVideoId){
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  conn.send({
Â  Â  Â  Â  Â  Â  type:'sync',
Â  Â  Â  Â  Â  Â  action: player.getPlayerState() === YT.PlayerState.PLAYING ? 'play' : 'pause',
Â  Â  Â  Â  Â  Â  time: player.getCurrentTime(),
Â  Â  Â  Â  Â  Â  vid: currentVideoId
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }, 1000);sÂ 
Â  Â  Â  }
Â  Â  });
Â  };

Â  $('joinBtn').onclick = tryJoin;
Â  roomIdInput.addEventListener('keydown', e => { if (e.key === 'Enter') tryJoin(); });

Â  function tryJoin(){
Â  Â  const id = roomIdInput.value.trim();
Â  Â  const name = guestNameInput.value.trim(); // <-- Get name

Â  Â  // --- Validate Name ---
Â  Â  if (!name) {
Â  Â  Â  Â  showConnect('Please enter your name.');
Â  Â  Â  Â  guestNameInput.focus();
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  if (!id) {Â 
Â  Â  Â  Â  showConnect('Enter a room ID.');Â 
Â  Â  Â  Â  roomIdInput.focus();Â 
Â  Â  Â  Â  return;Â 
Â  Â  }
Â  Â Â 
Â  Â  isHost = false;
Â  Â  myName = name; // <-- Set name
Â  Â  
Â  Â  // --- FIXED: Use a specific server ---
Â  Â  peer = new Peer(undefined, { host: '0.peerjs.com', port: 443, path: '/' });
Â  Â Â 
Â  Â  // --- FIXED: Added error handler for guest ---
Â  Â  peer.on('error', err => {
Â  Â  Â  Â  console.error('PeerJS Error:', err);
Â  Â  Â  Â  showConnect(`Error: Could not connect to PeerJS server. Try again. [${err.type}]`);
Â  Â  });
Â  Â  
Â  Â  peer.on('open', () => {
Â  Â  Â  conn = peer.connect(id);
Â  Â  Â  conn.on('open', () => {
Â  Â  Â  Â  wireConnection();
Â  Â  Â  Â  toSession('guest');Â 
Â  Â  Â  });
Â  Â  Â  conn.on('error', (err) => {
Â  Â  Â  Â  showConnect('Connection Error: ' + err);
Â  Â  Â  });
Â  Â  });
Â  Â  
Â  Â  // This handler is for the peer object itself (e.g., invalid ID)
Â  Â  peer.on('error', (err) => {
Â  Â  Â  showConnect('Peer Error: ' + err);
Â  Â  });
Â  }

Â  // --- MERGED wireConnection ---
Â  function wireConnection(){
Â  Â  conn.on('open', () => {
Â  Â  Â  Â  console.log('DEBUG: Connection open. Exchanging names.');
Â  Â  Â  Â  conn.send({ type: 'name', name: myName });
Â  Â  });
Â Â 
Â  Â  conn.on('data', data => {
Â  Â  Â  // --- Name handler ---
Â  Â  Â  if (data.type === 'name') {
Â  Â  Â  Â  Â  peerName = data.name;
Â  Â  Â  Â  Â  console.log(`DEBUG: Received peer name: ${peerName}`);
Â  Â  Â  Â  Â  addBubble(`<i>System: ${escapeHtml(peerName)} has joined the room.</i>`, 'sys');
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (isHost) {
Â  Â  Â  Â  Â  Â  Â  conn.send({ type: 'name', name: myName });
Â  Â  Â  Â  Â  Â  Â  setStatus(`Connected to ${peerName}`);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  setStatus(`Connected to Host`);
s Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // --- Kick handler ---
Â  Â  Â  if (data.type === 'system' && data.action === 'kick') {
s Â  Â  Â  Â  alert(`You were disconnected: ${data.reason}`);
Â  Â  Â  Â  Â  location.reload();
Â  Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // --- Chat handler ---
Â  Â  Â  if (data.type === 'chat'){
Â  Â  Â  Â  Â  log(`<b>${escapeHtml(peerName)}:</b> ${escapeHtml(data.text)}`, 'peer');
Â  Â  Â Â 
Â  Â  Â  // --- YouTube Load handler ---
Â  Â  Â  } else if (data.type === 'cmd' && data.cmd === 'load'){
Â  Â  Â  Â  Â  guestLoadVideo(data.vid);
Â  Â  Â Â 
Â  Â  Â  // --- YouTube Sync handler ---
Â  Â  Â  } else if (data.type === 'sync'){
Â  Â  Â  Â  Â  if (!isHost) applySync(data);Â 
Â  Â  Â  }
Â  Â  });
Â  Â Â 
Â  Â  conn.on('close', () => {
Â  Â  Â  console.warn(`CONNECTION CLOSED: ${peerName} connection was closed.`);
SESSION_ Â  Â  Â  addBubble(`<i>System: ${escapeHtml(peerName)} has disconnected.</i>`, 'sys');
Â  Â  Â Â 
Â  Â  Â  cleanupCall(); // <-- Clean up video call
Â  Â  Â Â 
Â  Â  Â  peerName = 'Guest';Â 
Â  Â  Â Â 
Â  Â  Â  if (isHost) {
Â  Â  Â  Â  Â  conn = null; // <-- Unlock room
Â  Â  Â  Â  Â  setStatus('Peer disconnected. Room is now open.');
Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert('Host disconnected. Reloading page.');
Â  Â  Â  Â  Â  location.reload();
Â  Â  Â  }
Â  Â  });
Â  }
Â Â 
Â  // --- ADDED CHAT sendMsg ---
Â  sendBtn.onclick = sendMsg;
Â  msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMsg(); });
Â Â 
Â  function sendMsg(){
Â  Â  Â  const el = msgInput, text = el.value.trim();
Â  Â  Â  if (!text) return;
Â  Â  Â Â 
Â  Â  Â  // No commands, just chat
Â  Â  Â Â 
Â  Â  Â  log(`<b>${escapeHtml(myName)}:</b> ${escapeHtml(text)}`, 'me');
SESSION_ Â  Â  Â  conn?.send({type:'chat', text});
Â  Â  Â  el.value = '';
Â  }

Â  // === Media (WebRTC) ===
Â  async function ensureLocalStream(){
Â  Â  if (localStream) return localStream;
Â  Â  try{
Â  Â  Â  localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
Â  Â  Â  localVideo.srcObject = localStream;
Â  Â  Â  return localStream;
Â  Â  }catch(err){
Â  Â  Â  console.error('getUserMedia error', err);
Â  Â  Â  alert('Could not access camera/microphone.');
Â  Â  Â  throw err;
Â  Â  }
Â  }

Â  function cleanupCall(){
Â  Â  if (currentCall){
Â  Â  Â  currentCall.close();
Â  Â  Â  currentCall = null;
Â  Â  }
Â  Â  if (remoteVideo.srcObject){
Â  Â  Â  remoteVideo.srcObject.getTracks().forEach(t=>t.stop());
Â  Â  Â  remoteVideo.srcObject = null;
Â  Â  }
Â  }

Â  function setupCallHandlers(){
Â  Â  peer.on('call', async call => {
Â  Â  Â  try{
Â  Â  Â  Â  const stream = await ensureLocalStream();
Â  Â  Â  Â  call.answer(stream);
Â  Â  Â  Â  currentCall = call;
Â  Â  Â  Â  call.on('stream', remoteStream => {
Â  Â  Â  Â  Â  remoteVideo.srcObject = remoteStream;
Â  Â  Â  Â  });
Â  Â  Â  Â  call.on('close', ()=>{ cleanupCall(); });
Â  Â  Â  }catch(e){
Â  Â  Â  Â  console.error(e);
Â  Â  Â  }
Â  Â  });
Â  }

Â  async function startCall(){
Â  Â  if (!peer || !conn) return;
Â  Â  const targetId = conn.peer;sÂ 
Â  Â  try{
Â  Â  Â  const stream = await ensureLocalStream();
Â  Â  Â  const call = peer.call(targetId, stream);
Â  Â  Â  currentCall = call;
Â  Â  Â  call.on('stream', remoteStream => {
Â  Â  Â  Â  remoteVideo.srcObject = remoteStream;
Â  Â  Â  });
Â  Â  Â  call.on('close', ()=>{ cleanupCall(); });
Â  Â  }catch(e){
Â  Â  Â  console.error(e);
Â  Existing }
Â  }

Â  // === Buttons ===
Â  loadBtn.onclick = hostLoadVideo;

Â  startCallBtn.onclick = async () => {
Â  Â  if (!peer) return;
Â  Â  await startCall(); // Both host and guest can start the call
Â  };

Â  toggleMuteBtn.onclick = () => {
Â  Â  if (!localStream) return;
Â  Â  const audioTracks = localStream.getAudioTracks();
Â  Â  if (!audioTracks.length) return;
Â  Â  const enabled = audioTracks[0].enabled;
Â  Â  audioTracks.forEach(t => t.enabled = !enabled);
NEW Â  Â  toggleMuteBtn.textContent = enabled ? 'Unmute' : 'Mute';
Â  };

Â  toggleCamBtn.onclick = () => {
Â  Â  if (!localStream) return;
Â  Â  // --- BUG FIX: Changed getAudioTracks to getVideoTracks ---
Â  Â  const videoTracks = localStream.getVideoTracks();Â 
Â  Â  if (!videoTracks.length) return;
Â  Â  const enabled = videoTracks[0].enabled;
Â  Â  videoTracks.forEach(t => t.enabled = !enabled);
Â  Â  toggleCamBtn.textContent = enabled ? 'Camera On' : 'Camera Off';
Â  };

Â  endCallBtn.onclick = () => {
Â  Â  cleanupCall();
Â  Â  if (localStream){
Â  Â  Â  localStream.getTracks().forEach(t=>t.stop());
Â  Â  Â  localStream = null;
Â  Â  Â  localVideo.srcObject = null;
Â  Â  }
Â  };
Â Â 
Â  // --- ADDED TOGGLE BUTTON LOGIC ---
Â  showChatBtn.onclick = () => {
Â  Â  callPane.classList.add('hidden');
Â  Â  chatPane.classList.remove('hidden');
Â  Â  showChatBtn.classList.add('hidden');
s Â  Â  showCallBtn.classList.remove('hidden');
Â  Â  // Readjust composer height in case it wasn't measured
Â  Â  (function(){
Â  Â  Â  const composer = document.querySelector('.composer');
Â  Â  Â  if (composer) document.documentElement.style.setProperty('--composer-h', composer.offsetHeight + 'px');
Â  Â  })();
Â  };
Â  showCallBtn.onclick = () => {
Â  Â  callPane.classList.remove('hidden');
Â  Â  chatPane.classList.add('hidden');
Â  Â  showChatBtn.classList.remove('hidden');
Â  Â  showCallBtn.classList.add('hidden');
Â  };

Â  // Init: when peer is created, also prep call handlers
Â  const origPeer = Peer;
Â  Peer = function(...args){
Â  Â  const p = new origPeer(...args);
Â  Â  p.on('open', ()=>{ setupCallHandlers(); });
Â  Â  return p;
s };
Â Â 
Â  // --- ADDED KEYBOARD AWARE CHAT ---
Â  (function setupKeyboardAwareChat(){
Â  Â  Â  const vv = window.visualViewport;
Â  Â  Â  const composer = document.querySelector('.composer');
Â  Â  Â  function setVar(name, val){ document.documentElement.style.setProperty(name, val); }
Â  Â  Â  function measureComposer(){
Â  Â  Â  Â  Â  if (composer) setVar('--composer-h', composer.offsetHeight + 'px');
Â  Â  Â  }
Â  Â  Â  function updateKeyboardOffset(){
Â  Â  Â  Â  Â  const kb = vv ? Math.max(0, (window.innerHeight - vv.height - vv.offsetTop)) : 0;
Â  Â  Â  Â  Â  const isOpen = kb > 120;Â 
Â  Â  Â  Â  Â  setVar('--kbd', (isOpen ? kb : 0) + 'px');
Â  s Â  Â  Â  document.body.classList.toggle('kbd-open', isOpen);
Â  Â  Â  Â  Â  measureComposer();
Â  Â  Â  }
Â  Â  Â  window.addEventListener('load', updateKeyboardOffset, { once:true });
Â  Â  Â  window.addEventListener('resize', updateKeyboardOffset);
Â  Â  Â  if (vv) vv.addEventListener('resize', updateKeyboardOffset);
Â  Â  Â  if (vv) vv.addEventListener('scroll', updateKeyboardOffset);
Â  })();
</script>

<script src="https://www.youtube.com/iframe_api"></script>

</body>
</html>
